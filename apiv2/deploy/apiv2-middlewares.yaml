apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: apiv2-path-rewrites
  namespace: orch-gateway
spec:
  chain:
    middlewares:
      # First: Redirect new OS path to legacy endpoint
      - name: apiv2-redirect-os
      # Second: Fix hosts summary path
      - name: apiv2-fix-hosts-summary
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: apiv2-redirect-os
  namespace: orch-gateway
spec:
  replacePathRegex:
    # Redirect new multi-tenant OS path to legacy OS endpoint
    # UI calls: /v1/projects/{projectName}/compute/os
    # API expects: /edge-infra.orchestrator.apis/v2/operating_systems
    # OS service hasn't been migrated to multi-tenant paths yet
    regex: "^/v1/projects/[^/]+/compute/os(/.*)?$"
    replacement: "/edge-infra.orchestrator.apis/v2/operating_systems$1"
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: apiv2-fix-hosts-summary
  namespace: orch-gateway
spec:
  replacePathRegex:
    # Fix UI bug: UI calls /hosts/summary but API expects /hosts_summary
    # This middleware rewrites the incorrect path to the correct one
    regex: "^(/v1/projects/[^/]+/compute)/hosts/summary"
    replacement: "${1}/hosts_summary"
---
# NOTE: apiv2-add-project-id middleware removed
# ActiveProjectID is now extracted at application level by apiv2 proxy:
# - New multi-tenant paths (/v1/projects/{projectName}/*): Extract project name from URL, resolve UUID via Nexus API
# - Old-style paths (/edge-infra.orchestrator.apis/v2/*): Extract project UUID directly from JWT token roles
# This eliminates the need for hardcoded project IDs and enables true multi-tenant support
