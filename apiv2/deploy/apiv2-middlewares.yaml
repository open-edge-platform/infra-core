# SPDX-FileCopyrightText: (C) 2025 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

# TO BE REMOVE AFTER MIGRATION COMPLETED
# Traefik Middlewares for apiv2 path rewrites
# Used in apiv2-nexus-api-ingressroute.yaml for multi-tenant compute APIs
# Currently covers:
# - HostService: /v1/projects/{projectName}/compute/hosts
# - OperatingSystemService: /v1/projects/{projectName}/compute/os (not yet migrated)
# Includes path rewrites for UI compatibility:
# - /hosts/summary -> /hosts_summary (UI bug fix)
# - /compute/os -> /edge-infra.orchestrator.apis/v2/operating_systems (OS not migrated yet)
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: apiv2-path-rewrites
  namespace: orch-gateway
spec:
  chain:
    middlewares:
      # First: Redirect new OS path to legacy endpoint
      - name: apiv2-redirect-os
      # Second: Fix hosts summary path
      - name: apiv2-fix-hosts-summary
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: apiv2-redirect-os
  namespace: orch-gateway
spec:
  replacePathRegex:
    # Redirect new multi-tenant OS path to legacy OS endpoint
    # UI calls: /v1/projects/{projectName}/compute/os
    # API expects: /edge-infra.orchestrator.apis/v2/operating_systems
    # OS service hasn't been migrated to multi-tenant paths yet
    regex: "^/v1/projects/[^/]+/compute/os(/.*)?$"
    replacement: "/edge-infra.orchestrator.apis/v2/operating_systems$1"
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: apiv2-fix-hosts-summary
  namespace: orch-gateway
spec:
  replacePathRegex:
    # Fix UI bug: UI calls /hosts/summary but API expects /hosts_summary
    # This middleware rewrites the incorrect path to the correct one
    regex: "^(/v1/projects/[^/]+/compute)/hosts/summary"
    replacement: "${1}/hosts_summary"
