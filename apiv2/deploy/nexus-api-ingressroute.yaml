# SPDX-FileCopyrightText: (C) 2025 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

# Traefik IngressRoute for api.kind.internal routing
# Routes migrated EIM APIs directly to apiv2 (bypassing nexus-api-gateway)
# Routes all other APIs through nexus-api-gateway (existing behavior)
#
# 18 EIM services have been migrated to multi-tenant paths:
# 1. RegionService: /v1/projects/{projectName}/regions
# 2. SiteService: /v1/projects/{projectName}/sites
# 3. LocationService: /v1/projects/{projectName}/locations
# 4. HostService: /v1/projects/{projectName}/compute/hosts
# 5. InstanceService: /v1/projects/{projectName}/compute/instances
# 6. OperatingSystemService: /v1/projects/{projectName}/compute/os
# 7. ProviderService: /v1/projects/{projectName}/providers
# 8. WorkloadService: /v1/projects/{projectName}/workloads
# 9. WorkloadMemberService: /v1/projects/{projectName}/workload_members
# 10. ScheduleService: /v1/projects/{projectName}/schedules
# 11. TelemetryLogsGroupService: /v1/projects/{projectName}/telemetry/groups/logs
# 12. TelemetryMetricsGroupService: /v1/projects/{projectName}/telemetry/groups/metrics
# 13. TelemetryLogsProfileService: /v1/projects/{projectName}/telemetry/profiles/logs
# 14. TelemetryMetricsProfileService: /v1/projects/{projectName}/telemetry/profiles/metrics
# 15. LocalAccountService: /v1/projects/{projectName}/localAccounts
# 16. CustomConfigService: /v1/projects/{projectName}/customConfigs
# 17. OSUpdatePolicyService: /v1/projects/{projectName}/os-update-policies
# 18. OSUpdateRunService: /v1/projects/{projectName}/os-update-runs
#
# Non-migrated services continue to route through nexus-api-gateway as usual:
# - AppDeployment: /v1/projects/{projectName}/appdeployment/*
# - Alerts: /v1/projects/{projectName}/alerts/*
# - (and other non-EIM services)
#
# Legacy paths (/edge-infra.orchestrator.apis/v2/*) are supported via additional_bindings
# in the proto file for backward compatibility and are routed directly to apiv2.
---
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: nexus-api-http
  namespace: orch-gateway
spec:
  entryPoints:
    - websecure
  routes:
    # Route for migrated EIM endpoints - direct to apiv2 (bypass nexus-api-gw)
    # Covers all 18 migrated services with explicit paths
    # Only routes migrated services; others fall through to nexus-api-gateway
    # UI paths (/compute/os, /compute/os_update_policy) via proto bindings
    # NOTE: ActiveProjectID extracted at app level using orch-library
    - match: >-
        Host(`api.kind.internal`) &&
        PathRegexp(`^/v1/projects/[^/]+/(compute|sites|regions|locations|
        providers|workloads|workload_members|schedules|telemetry|
        localAccounts|customConfigs|os-update-policies|os-update-runs)(/|$)`)
      kind: Rule
      priority: 50
      middlewares:
        - name: validate-jwt
        - name: apiv2-path-rewrites
        - name: secure-headers
      services:
        - name: apiv2-proxy
          namespace: orch-infra
          port: 8080
          scheme: http

    # Route for legacy API paths - direct to apiv2 (backward compatibility)
    # Supports old paths via proto additional_bindings: /edge-infra.orchestrator.apis/v2/*
    # NOTE: ActiveProjectID is extracted from JWT token roles at application level
    - match: Host(`api.kind.internal`) && PathPrefix(`/edge-infra.orchestrator.apis/v2`)
      kind: Rule
      priority: 40
      middlewares:
        - name: validate-jwt
        - name: secure-headers
      services:
        - name: apiv2-proxy
          namespace: orch-infra
          port: 8080
          scheme: http

    # Route for all other API calls - through nexus-api-gateway
    # Includes: projects, tenancy, infrastructure metadata
    - match: Host(`api.kind.internal`) && PathPrefix(`/`)
      kind: Rule
      priority: 20
      middlewares:
        - name: iam-nexus-api-gw-http
        - name: validate-jwt
        - name: secure-headers
      services:
        - name: svc-iam-nexus-api-gw
          namespace: orch-iam
          port: 8082
          scheme: http
  tls:
    options:
      name: gateway-tls
      namespace: orch-gateway
    secretName: tls-orch
