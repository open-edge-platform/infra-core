# SPDX-FileCopyrightText: (C) 2026 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

# Traefik IngressRoute for api.kind.internal routing
# Routes migrated EIM APIs directly to apiv2 (bypassing nexus-api-gateway)
# Routes all other APIs through nexus-api-gateway (existing behavior)
#
# 18 EIM services migrated (UI paths listed, middleware rewrites to backend):
# 1. RegionService: /v1/projects/{projectName}/regions
# 2. SiteService: /v1/projects/{projectName}/sites
#    (also /regions/{id}/sites -> rewritten to /sites)
# 3. LocationService: /v1/projects/{projectName}/locations
# 4. HostService: /v1/projects/{projectName}/compute/hosts
#    (also /compute/hosts/summary -> /compute/hosts_summary)
# 5. InstanceService: /v1/projects/{projectName}/compute/instances
# 6. OperatingSystemService: /v1/projects/{projectName}/compute/os
#    (rewritten to /compute/operating_systems)
# 7. ProviderService: /v1/projects/{projectName}/providers
# 8. WorkloadService: /v1/projects/{projectName}/workloads
# 9. WorkloadMemberService:
#    /v1/projects/{projectName}/workload_members
# 10. ScheduleService: /v1/projects/{projectName}/schedules
# 11. TelemetryLogsGroupService:
#     /v1/projects/{projectName}/telemetry/loggroups
# 12. TelemetryMetricsGroupService:
#     /v1/projects/{projectName}/telemetry/metricgroups
# 13. TelemetryLogsProfileService:
#     /v1/projects/{projectName}/telemetry/logprofiles
# 14. TelemetryMetricsProfileService:
#     /v1/projects/{projectName}/telemetry/metricprofiles
# 15. LocalAccountService: /v1/projects/{projectName}/localAccounts
# 16. CustomConfigService: /v1/projects/{projectName}/customConfigs
# 17. OSUpdatePolicyService:
#     /v1/projects/{projectName}/os-update-policies
# 18. OSUpdateRunService: /v1/projects/{projectName}/os-update-runs
#
# Non-migrated services route through nexus-api-gateway:
# - AppDeployment: /v1/projects/{projectName}/appdeployment/*
# - Alerts: /v1/projects/{projectName}/alerts/*
# - (and other non-EIM services)
#
# Legacy paths (/edge-infra.orchestrator.apis/v2/*) supported via
# additional_bindings in proto for backward compatibility, route to apiv2.
---
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: nexus-api-http
  namespace: orch-gateway
spec:
  entryPoints:
    - websecure
  routes:
    # Route for migrated EIM endpoints - direct to apiv2
    # Covers all 18 migrated services
    # PathRegexp matches UI paths; middleware rewrites to backend
    # Includes: compute/*, sites, regions, locations, providers,
    # workloads, schedules, telemetry, localAccounts, customConfigs,
    # os-update-*
    - match: >-
        Host(`api.kind.internal`) &&
        PathRegexp(`^/v1/projects/[^/]+/(compute|sites|regions|locations|providers|workloads|workload_members|telemetry|localAccounts|customConfigs|os-update-policies|os-update-runs)(/.*)?$`)
      kind: Rule
      priority: 50
      middlewares:
        - name: validate-jwt
        - name: secure-headers
      services:
        - name: apiv2-proxy
          namespace: orch-infra
          port: 8080
          scheme: http

    # Route for legacy API paths - direct to apiv2 (backward compatibility)
    # Supports old paths via proto additional_bindings: /edge-infra.orchestrator.apis/v2/*
    # NOTE: ActiveProjectID is extracted from JWT token roles at application level
    - match: Host(`api.kind.internal`) && PathPrefix(`/edge-infra.orchestrator.apis/v2`)
      kind: Rule
      priority: 40
      middlewares:
        - name: validate-jwt
        - name: secure-headers
      services:
        - name: apiv2-proxy
          namespace: orch-infra
          port: 8080
          scheme: http

    # Route for all other API calls - through nexus-api-gateway
    # Includes: projects, tenancy, infrastructure metadata
    - match: Host(`api.kind.internal`) && PathPrefix(`/`)
      kind: Rule
      priority: 20
      middlewares:
        - name: iam-nexus-api-gw-http
        - name: validate-jwt
        - name: secure-headers
      services:
        - name: svc-iam-nexus-api-gw
          namespace: orch-iam
          port: 8082
          scheme: http
  tls:
    options:
      name: gateway-tls
      namespace: orch-gateway
    secretName: tls-orch
