apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: nexus-api-http
  namespace: orch-gateway
spec:
  entryPoints:
    - websecure
  routes:
    # Route for multi-tenant compute endpoints - direct to apiv2 (bypass nexus-api-gw)
    - match: Host(`api.kind.internal`) && PathRegexp(`^/v1/projects/[^/]+/compute`)
      kind: Rule
      priority: 50
      middlewares:
        - name: validate-jwt
        - name: secure-headers
      services:
        - name: apiv2-proxy
          namespace: orch-infra
          port: 8080
          scheme: http
    # Route for all other API calls - through nexus-api-gateway
    - match: Host(`api.kind.internal`) && PathPrefix(`/`)
      kind: Rule
      priority: 20
      middlewares:
        - name: iam-nexus-api-gw-http
        - name: validate-jwt
        - name: secure-headers
      services:
        - name: svc-iam-nexus-api-gw
          namespace: orch-iam
          port: 8082
          scheme: http
  tls:
    options:
      name: gateway-tls
      namespace: orch-gateway
    secretName: tls-orch
